(function(d,c,a,e){var b=function(g,f){this._init()};b.prototype={constructor:b,_init:function(){var f=this;this.flow=new Flow({target:"uploadChunk",query:{upload_token:"my_token"},testChunks:false,method:"octet",chunkSize:4*1024*1024});this.flow.assignBrowse(a.getElementById("addfile"),false,false);this.flow.on("fileAdded",function(g,h){});this.flow.on("filesAdded",function(h,g){f.addFileToUI(h);console.log("files ========",h,g)});this.flow.on("fileSuccess",function(g,h){console.log(g,h)});this.flow.on("fileError",function(g,h){console.log(g,h)});this.flow.on("fileProgress",function(g){f.updateFileProgress(g)});this.flow.on("fileSuccess",function(g,h){d("#progress-"+g.uniqueIdentifier).addClass("progress-bar-green");d("#progress-"+g.uniqueIdentifier).removeClass("progress-bar-aqua")});d("#run").bind("click",{scope:this},function(g){g.data.scope.play()});d("#stop").bind("click",{scope:this},function(g){g.data.scope.cancel()})},addFileToUI:function(f){var q=d("#files");for(var l=0;l<f.length;l++){var h=f[l];var n=a.createElement("tr");n.id="line-"+h.uniqueIdentifier;var k=a.createElement("td");k.id="num-"+h.uniqueIdentifier;n.appendChild(k);var j=a.createElement("td");j.innerHTML=h.name;n.appendChild(j);var p=a.createElement("td");p.appendChild(this.createProgress(h));n.appendChild(p);var o=a.createElement("td");o.appendChild(this.createDiv("tds-"+h.uniqueIdentifier));n.appendChild(o);var g=a.createElement("td");g.appendChild(this.createInitButton(h));n.appendChild(g);var m=a.createElement("td");m.appendChild(this.createDeleteButton(h));n.appendChild(m);q.append(n);d("#del-"+h.uniqueIdentifier).bind("click",{scope:this,fileid:h.uniqueIdentifier},function(r){r.data.scope.removeFile(r.data.fileid);if(h.ajaxRequest!=e){try{h.ajaxRequest.abort()}catch(i){console.log("error abortando peticion")}}});d("#play-"+h.uniqueIdentifier).bind("click",{scope:this,fileid:h.uniqueIdentifier},function(i){i.data.scope.play(i.data.fileid)});this.generateUIFileIndex()}},createDeleteButton:function(g){var f=a.createElement("a");f.className="btn btn-danger btn-sm";f.id="del-"+g.uniqueIdentifier;var h=a.createElement("i");h.className="glyphicon glyphicon-remove";f.appendChild(h);return f},createInitButton:function(i){var h=a.createElement("a");h.className="btn btn-default has-spinner";h.name="play-"+i.uniqueIdentifier;h.id="play-"+i.uniqueIdentifier;var k=a.createElement("span");k.className="spinner fa fa-spinner fa-pulse";var j=a.createElement("span");j.className="fa fa-play";var g=d("#nif_empresa").val();var f=d("#nif_presentador").val();h.appendChild(k);h.appendChild(j);if(g==""||f==""){h.className="btn btn-default disabled"}return h},createProgress:function(f){var i=a.createElement("div");i.className="progress";i.style.backgroundColor="#eee";var h=a.createElement("div");h.id="progress-"+f.uniqueIdentifier;h.className="progress-bar progress-bar-aqua";h.style.width="0%";var g=a.createElement("span");g.id="progressText-"+f.uniqueIdentifier;h.appendChild(g);i.appendChild(h);return i},generateUIFileIndex:function(){d("#files td[id|='num']").each(function(f){d(this).html((f+1)+".")})},createDiv:function(g){var f=a.createElement("div");f.id=g;return f},play:function(g){var h=this.flow.getFromUniqueIdentifier(g);this.upLoadFile(h);var f=d("#play-"+g);f.children().removeClass("fa-play");f.toggleClass("active");f.unbind("click");self=this;c.setTimeout(function(){var i=d("#play-"+g);i.toggleClass("active");i.children().addClass("fa-stop");i.bind("click",{scope:self,fileid:g},function(j){j.data.scope.stop(j.data.fileid)})},1000)},stop:function(g){var f=d("#play-"+g);f.children().addClass("fa-play");f.children().removeClass("fa-stop");var i=this.flow.getFromUniqueIdentifier(g);if(i.ajaxRequest!=e){try{i.ajaxRequest.abort()}catch(h){console.log("error abortando peticion")}}f.unbind("click");f.bind("click",{scope:this,fileid:i.uniqueIdentifier},function(j){j.data.scope.play(j.data.fileid)});d("#progressText-"+i.uniqueIdentifier).html("");d("#progress-"+i.uniqueIdentifier).css("width","0%");d("#progress-"+i.uniqueIdentifier).css("min-width","0px");if(i.uuidCarga!=e){d.ajax({url:localStorage.getItem(localStorage.getItem("entorno"))+"carga/v1/cancelar_carga//"+i.uuidCarga,type:"GET",success:function(j,k){console.log("carga cancelada");console.log(j)},error:function(k,j){d.fn.error("Error en la peticion",k.responseText)}})}},pause:function(){this.flow.pause();d("#run").unbind("click");d("#run i").addClass("fa-play");d("#run i").removeClass("fa-pause");d("#run span").text("Reanudar");d("#run").bind("click",{scope:this},function(f){f.data.scope.resume()})},resume:function(){d("#totalProgress").css("min-width","20px");this.flow.resume();d("#run").unbind("click");d("#run i").addClass("fa-pause");d("#run i").removeClass("fa-play");d("#run span").text("Pausar");d("#run").bind("click",{scope:this},function(f){f.data.scope.pause()})},cancel:function(){this.flow.cancel();d("#stop").addClass("disabled");d("#run").unbind("click");d("#run i").addClass("fa-play");d("#run i").removeClass("fa-pause");d("#run span").text("Iniciar");d("#run").bind("click",{scope:this},function(f){f.data.scope.play()})},removeFile:function(f){console.log("borramos el fichero "+f);this.flow.removeFile(this.flow.getFromUniqueIdentifier(f));d("#line-"+f).detach();this.generateUIFileIndex()},updateTotalProgress:function(){console.log(this.flow.progress());var f=Math.floor(this.flow.progress()*100);d("#totalProgress").css("width",f+"%");d("#totalProgressText").html(f+"%")},updateFileProgress:function(f){var g=Math.floor(f.progress()*100);d("#progress-"+f.uniqueIdentifier).css("min-width","20px");d("#progress-"+f.uniqueIdentifier).css("width",g+"%");d("#progressText-"+f.uniqueIdentifier).html(g+"%")},upLoadFile:function(h){var i=new FormData();var g;var f={nifPresentador:d("#nif_presentador").val(),nifEmpresa:d("#nif_empresa").val(),idProcedimiento:d("#proce option:selected").val()};self=this;d.ajax({url:localStorage.getItem(localStorage.getItem("entorno"))+"carga/v1/iniciar_carga/",type:"POST",data:JSON.stringify(f),dataType:"json",contentType:"application/json",success:function(k,l){console.log("carga iniciada");console.log(k);g=k.uuidCarga;h.uuidCarga=g;var j=localStorage.getItem(localStorage.getItem("entorno"))+"carga/v1/subir_fichero_completo?uuidCarga="+h.uuidCarga+"&tipoFichero="+d("#tFichero option:selected").text()+"&nombreFichero="+h.name+"&numeroBytes="+h.size;i.append("file",h.file);h.ajaxRequest=d.ajax({url:j,type:"POST",xhr:function(){var m=d.ajaxSettings.xhr();if(m.upload){m.upload.addEventListener("progress",function(n){console.log(n);var o=Math.floor((n.loaded/n.total)*100);o=(o==100?99:o);console.log(o);d("#progress-"+h.uniqueIdentifier).css("min-width","20px");d("#progress-"+h.uniqueIdentifier).css("width",o+"%");d("#progressText-"+h.uniqueIdentifier).html(o+"%")},false)}return m},success:function(m,n){console.log("Subida ok");console.log(m);d.ajax({url:localStorage.getItem(localStorage.getItem("entorno"))+"carga/v1/confirmar_carga/"+g,type:"GET",success:function(o,q){console.log("carga confirmada");d("#progressText-"+h.uniqueIdentifier).html("100%");d("#progress-"+h.uniqueIdentifier).css("width","100%");d("#progress-"+h.uniqueIdentifier).addClass("progress-bar-green");d("#progress-"+h.uniqueIdentifier).removeClass("progress-bar-aqua");var p=d("#play-"+h.uniqueIdentifier).parent()[0];d("#play-"+h.uniqueIdentifier).remove();p.appendChild(d.fn.createEstadoButton(h,h.uuidCarga));d("#est-"+h.uniqueIdentifier).click(function(){d.fn.consultaEstado(d(this),h.name)})},error:function(p,o){if(p.statusText!="abort"){d.fn.error("Error en la peticion",p.responseText);d("#play-"+h.uniqueIdentifier).remove()}}})},error:function(n,m){if(n.statusText!="abort"){d.fn.error("Error en la peticion",n.responseText);d("#play-"+h.uniqueIdentifier).remove()}},data:i,cache:false,contentType:false,processData:false}).always(function(m,n){if(n!="success"&&n!="abort"){d.fn.error("Error en la peticion",n.responseText=""?n:n.responseText);d("#play-"+h.uniqueIdentifier).remove()}})},error:function(k,j){d.fn.error("Error en la peticion",k.responseText);d("#play-"+h.uniqueIdentifier).remove()}})}};d.fn.consultaEstado=function(g,f){g.toggleClass("active");var h=g[0].getAttribute("data-uuid");d.ajax({url:localStorage.getItem(localStorage.getItem("entorno"))+"carga/v1/consultar_estado_carga/"+h,type:"GET",success:function(l,i){console.log("estado carga");console.log(l);var o=d("#modalEstado");d("#modal-title").text(f);var q=a.createElement("p");q.innerText="UuidCarga: "+h;var n=a.createElement("a");var j=a.createElement("p");try{if(l.errores.length>0){n.setAttribute("href",l.errores[0].url);n.text="Errores"}}catch(p){console.log(p)}j.innerText="Estado: "+l.estado;var k=a.createElement("p");k.innerText="Registros: "+l.registrosErrores+" errores / "+l.registrosProcesados+" procesados";var m=d("#modal-body")[0];m.textContent="";m.appendChild(q);m.appendChild(j);m.appendChild(k);m.appendChild(n);o.modal("show");g.toggleClass("active")},error:function(j,i){d.fn.error("Error en la peticion",j.responseText)}})};d.fn.createEstadoButton=function(g,i){var f=a.createElement("a");f.className="btn btn-default consultaEstado has-spinner";f.id="est-"+g.uniqueIdentifier;f.setAttribute("data-uuid",i);var h=a.createElement("span");h.className="spinner fa fa-spinner fa-pulse";var j=a.createElement("span");j.innerText=" Consultar estado";f.appendChild(h);f.appendChild(j);return f};d.fn.error=function(f,g){d("#MensajeError").text(f);if(g+""==""||g==e){d("#preError").hide()}else{try{d("#preError").text(JSON.stringify(JSON.parse(g),e,2))}catch(h){d("#preError").text(g)}d("#preError").show()}d("#alertError").show()};d.fn.sleep=function(f){var h=new Date().getTime();for(var g=0;g<10000000;g++){if((new Date().getTime()-h)>f){break}}};d.fn.uploaderFile=function(g){var f=Array.apply(null,arguments);f.shift();return this.each(function(){var j=d(this),i=j.data("uploaderFile"),h=typeof g==="object"&&g;if(!i){j.data("uploaderFile",(i=new b(this,d.extend({},d.fn.uploaderFile.defaults,h,d(this).data()))))}if(typeof g==="string"){i[g].apply(i,f)}})};d.fn.uploaderFile.defaults={};d.fn.uploaderFile.Constructor=b})(jQuery,window,document);